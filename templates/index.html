<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Painel Preditivo — Jardim Camburi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg: #f3f4f6;
      --bg-card: #ffffff;
      --accent: #005ca9;
      --accent-soft: #0ea5e9;
      --accent-green: #16a34a;
      --text-main: #111827;
      --text-soft: #6b7280;
      --border-soft: #dde1e7;
      --danger: #dc2626;
      --warning: #d97706;
    }

    * { box-sizing: border-box; }

    body {
      background: var(--bg);
      color: var(--text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .top-bar {
      width: 100%;
      background: var(--accent);
      color: #ffffff;
      padding: 0.45rem 0.75rem;
      font-size: 0.85rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .top-bar-title {
      font-weight: 600;
    }

    .wrapper {
      max-width: 1320px;
      margin: 0 auto;
      padding: 1.25rem 0 2.5rem;
    }

    .card-shell {
      background: var(--bg-card);
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 2px 4px rgba(15,23,42,0.05);
    }

    .card-inner {
      border-radius: 10px;
      padding: 0.9rem 1rem;
    }

    .badge-chip {
      font-size: 0.75rem;
      padding: 0.2rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      color: var(--accent);
      background: #e0ebf7;
    }

    .badge-chip-primary {
      background: linear-gradient(135deg, #0ea5e9, #22c55e);
      border-color: transparent;
      color: #ffffff;
    }

    .kpi-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent);
    }

    .kpi-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-soft);
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 0.15rem;
    }

    .section-sub {
      font-size: 0.75rem;
      color: var(--text-soft);
      margin-bottom: 0.2rem;
    }

    .pill-risk {
      border-radius: 999px;
      font-size: 0.7rem;
      padding: 0.12rem 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 600;
      color: #ffffff;
    }
    .pill-risk-alto   { background: var(--danger); }
    .pill-risk-medio  { background: var(--warning); }
    .pill-risk-baixo  { background: var(--accent-green); }

    .small-muted {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .list-row {
      padding: 0.28rem 0;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.85rem;
    }
    .list-row:last-child { border-bottom: none; }

    .list-row-clickable {
      cursor: pointer;
      transition: background 0.12s ease;
    }
    .list-row-clickable:hover {
      background: #f9fafb;
    }

    #map {
      width: 100%;
      height: 260px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }

    #forecastChart,
    #crimeHoraChart,
    #crimeBairroChart {
      width: 100%;
      height: 220px;
    }

    .badge-soft {
      font-size: 0.7rem;
      padding: 0.12rem 0.45rem;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      color: var(--text-soft);
      background: #f9fafb;
    }

    .chip-critico {
      font-size: 0.8rem;
      padding: 0.18rem 0.6rem;
      border-radius: 999px;
      background: #fee2e2;
      border: 1px solid #fecaca;
      color: #991b1b;
    }

    .chip-info {
      font-size: 0.8rem;
      padding: 0.18rem 0.6rem;
      border-radius: 999px;
      background: #e0f2fe;
      border: 1px solid #bfdbfe;
      color: #1d4ed8;
    }

    .heatmap-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }
    .heatmap-table th,
    .heatmap-table td {
      border: 1px solid #e5e7eb;
      padding: 0.25rem 0.3rem;
      text-align: center;
      white-space: nowrap;
    }

    .heat-cell {
      min-width: 32px;
      background: #f9fafb;
    }
    .heat-low    { background: #dcfce7; }
    .heat-medium { background: #fef3c7; }
    .heat-high   { background: #fee2e2; }

    .nav-tabs .nav-link {
      font-size: 0.85rem;
    }

    .tv-mode .top-bar {
      display: none;
    }
    .tv-mode .wrapper {
      max-width: 100%;
      padding-top: 0.5rem;
    }
    .tv-mode .kpi-value {
      font-size: 2.4rem;
    }

    @media (max-width: 991.98px) {
      .wrapper { padding-inline: 0.75rem; }
      .kpi-value { font-size: 1.6rem; }
    }

    @media print {
      .top-bar,
      .no-print {
        display: none !important;
      }
      body {
        background: #ffffff;
      }
      .wrapper {
        max-width: 100%;
        padding: 0;
      }
    }
  </style>
</head>

<body>
  <!-- Barra superior -->
  <div class="top-bar no-print">
    <div class="top-bar-title">Guarda Municipal — Painel Preditivo Jardim Camburi</div>
    <div class="small-muted text-white">Atualizado em {{ ultima_atualizacao }}</div>
  </div>

  <div class="wrapper">

    <!-- Header + ações -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
      <div>
        <h5 class="mb-1 fw-semibold">Painel Preditivo — Jardim Camburi</h5>
        <div class="small-muted">
          Motor preditivo por crime, horário e bairro • Série histórica desde 2020
        </div>
      </div>
      <div class="d-flex flex-wrap gap-2 no-print">
        <span class="badge-chip badge-chip-primary">Engine N7 • IA Tática</span>
        <button id="btnTvMode" class="btn btn-sm btn-outline-primary">Modo tela cheia</button>
        <button onclick="window.print()" class="btn btn-sm btn-outline-secondary">Imprimir / Exportar</button>
      </div>
    </div>

    <!-- KPIs principais -->
    <div class="row g-3 mb-3">
      {% for k in kpis %}
      <div class="col-6 col-lg-3">
        <div class="card-shell h-100">
          <div class="card-inner">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="kpi-value">{{ k.valor }}</div>
                <div class="kpi-label">{{ k.nome }}</div>
              </div>
              <span class="badge-soft">ℹ️</span>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Linha com previsão global + previsibilidade -->
    <div class="row g-3 mb-3">
      <!-- Forecast global -->
      <div class="col-lg-8">
        <div class="card-shell h-100">
          <div class="card-inner h-100 d-flex flex-column">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="section-title">Curva de pressão preditiva — próximas 24h</span>
              <span class="badge-soft">Distribuição horária (todos os crimes)</span>
            </div>
            <div class="small-muted mb-2">
              Gerada automaticamente pelo modelo com base no histórico consolidado do bairro.
            </div>
            <div class="flex-grow-1 d-flex">
              <canvas id="forecastChart" class="flex-grow-1"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Previsibilidade dos fatos -->
      <div class="col-lg-4">
        <div class="card-shell h-100">
          <div class="card-inner h-100 d-flex flex-column">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="section-title">Previsibilidade dos fatos (IA)</span>
              <span class="badge-soft">índices sintéticos do modelo</span>
            </div>
            <div class="small-muted mb-2">
              O painel analisa automaticamente a “desenhabilidade” dos picos de crime para estimar o quão previsível está o cenário.
            </div>
            <div id="previsibilidadeResumo" class="mb-2"></div>
            <div class="small-muted">
              <ul id="previsibilidadeLista" class="mb-0"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Abas analíticas (por crime / crime x hora x bairro / operacional) -->
    <ul class="nav nav-tabs mb-3" id="painelTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-crime" data-bs-toggle="tab" data-bs-target="#pane-crime" type="button" role="tab">
          Por crime (IA)
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-matriz" data-bs-toggle="tab" data-bs-target="#pane-matriz" type="button" role="tab">
          Crime × hora × bairro
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-op" data-bs-toggle="tab" data-bs-target="#pane-op" type="button" role="tab">
          Visão operacional
        </button>
      </li>
    </ul>

    <div class="tab-content mb-3">
      <!-- ABA 1: POR CRIME -->
      <div class="tab-pane fade show active" id="pane-crime" role="tabpanel">
        <div class="row g-3">
          <!-- seletor de crime + resumo + explicador -->
          <div class="col-lg-3">
            <div class="card-shell h-100">
              <div class="card-inner h-100 d-flex flex-column">
                <div class="section-title mb-1">Selecione o crime</div>
                <div class="small-muted mb-2">
                  O motor de IA recalcula a análise para o crime escolhido.
                </div>
                <select id="crimeSelect" class="form-select form-select-sm mb-2">
                  <!-- opções via JS -->
                </select>
                <div id="crimeResumo" class="small-muted mb-2"></div>
                <div class="section-sub mb-1">Explicador inteligente</div>
                <div id="crimeInsight" class="small-muted">
                  <!-- insight textual dinâmico -->
                </div>
              </div>
            </div>
          </div>

          <!-- crime x hora -->
          <div class="col-lg-4">
            <div class="card-shell h-100">
              <div class="card-inner h-100 d-flex flex-column">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <span class="section-title">Crime × hora (perfil temporal)</span>
                  <span class="badge-soft">Distribuição horária do crime</span>
                </div>
                <div class="small-muted mb-2">
                  O modelo identifica janelas de maior pressão horária para o crime selecionado.
                </div>
                <div class="flex-grow-1 d-flex">
                  <canvas id="crimeHoraChart" class="flex-grow-1"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- crime x bairro -->
          <div class="col-lg-5">
            <div class="card-shell h-100">
              <div class="card-inner h-100 d-flex flex-column">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <span class="section-title">Crime × bairro (perfil espacial)</span>
                  <span class="badge-soft">Concentração territorial do crime</span>
                </div>
                <div class="small-muted mb-2">
                  Ranking dos bairros onde o modelo detecta maior densidade histórica para o crime escolhido.
                </div>
                <div class="flex-grow-1 d-flex">
                  <canvas id="crimeBairroChart" class="flex-grow-1"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ABA 2: MATRIZ CRIME × HORA × BAIRRO -->
      <div class="tab-pane fade" id="pane-matriz" role="tabpanel">
        <div class="card-shell">
          <div class="card-inner">
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
              <div>
                <div class="section-title mb-1">Matriz crime × hora × bairro</div>
                <div class="small-muted">
                  Principais combinações onde o modelo identifica padrão repetitivo de tempo e espaço.
                </div>
              </div>
              <div class="d-flex align-items-center gap-2">
                <span class="badge-soft">Top 50 pares preditivos</span>
              </div>
            </div>
            <div class="table-responsive mb-2">
              <table class="heatmap-table" id="crimeHoraBairroHeatmap"></table>
            </div>
            <div class="small-muted">
              Células mais escuras indicam pontos onde a **probabilidade condicional** de ocorrência se destaca em relação ao restante da série.
            </div>
          </div>
        </div>
      </div>

      <!-- ABA 3: OPERACIONAL -->
      <div class="tab-pane fade" id="pane-op" role="tabpanel">
        <div class="row g-3">
          <!-- horários críticos -->
          <div class="col-lg-3">
            <div class="card-shell h-100">
              <div class="card-inner h-100 d-flex flex-column">
                <div class="section-title mb-1">Horários críticos (geral)</div>
                <div class="flex-grow-1">
                  {% if top_horarios %}
                    {% for h in top_horarios %}
                    <div class="list-row list-row-clickable d-flex justify-content-between align-items-center"
                         data-hour="{{ h.hora }}">
                      <span>{{ "%02d"|format(h.hora) }}h</span>
                      <span class="pill-risk
                        {% if h.risco == 'alto' %}pill-risk-alto
                        {% elif h.risco == 'medio' %}pill-risk-medio
                        {% else %}pill-risk-baixo
                        {% endif %}">
                        {{ h.risco|capitalize }}
                      </span>
                    </div>
                    {% endfor %}
                  {% else %}
                    <div class="small-muted">Sem dados suficientes.</div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- logradouros -->
          <div class="col-lg-3">
            <div class="card-shell h-100">
              <div class="card-inner h-100 d-flex flex-column">
                <div class="section-title mb-1">Logradouros mais sensíveis</div>
                <div class="flex-grow-1">
                  {% if top_logradouros %}
                    {% for l in top_logradouros %}
                    <div class="list-row list-row-clickable d-flex justify-content-between align-items-center"
                         data-logradouro="{{ l.logradouro | upper }}">
                      <div>{{ l.logradouro }}</div>
                      <strong>{{ l.total }}</strong>
                    </div>
                    {% endfor %}
                  {% else %}
                    <div class="small-muted">Sem dados.</div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- mapa -->
          <div class="col-lg-6">
            <div class="card-shell h-100">
              <div class="card-inner h-100 d-flex flex-column">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <span class="section-title mb-0">Mapa tático preditivo</span>
                  <span class="badge-soft">Intensidade histórica por logradouro</span>
                </div>
                <div id="map" class="mt-1 flex-grow-1"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alertas -->
    <div class="row g-3">
      <div class="col-12">
        <div class="card-shell">
          <div class="card-inner">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="section-title">Alertas automáticos do modelo</span>
              <span class="badge-soft">desvios e concentrações relevantes</span>
            </div>
            <div class="d-flex flex-wrap gap-2" id="alertasContainer">
              {% if alertas %}
                {% for a in alertas %}
                <div class="chip-critico">
                  <strong>{{ a.titulo }}</strong>
                  <span class="small-muted ms-1">{{ a.descricao }}</span>
                </div>
                {% endfor %}
              {% endif %}
            </div>
            {% if not alertas %}
            <div class="small-muted mt-1" id="alertasFallback">
              Nenhum alerta cadastrado. Alertas cognitivos serão gerados conforme o padrão das projeções.
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

  </div><!-- wrapper -->

  <!-- Bootstrap JS (tabs) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Scripts -->
  <script>
    const projecoes24h     = {{ projecoes_24h     | tojson | safe }};
    const topLogradouros   = {{ top_logradouros   | tojson | safe }};
    const crimesResumo     = {{ crimes_resumo     | tojson | safe }};
    const crimeHora        = {{ crime_hora        | tojson | safe }};
    const crimeHoraBairro  = {{ crime_hora_bairro | tojson | safe }};

    // ---------- TV MODE ----------
    (function(){
      const btn = document.getElementById('btnTvMode');
      if (!btn) return;
      btn.addEventListener('click', () => {
        document.body.classList.toggle('tv-mode');
        if (document.body.classList.contains('tv-mode')) {
          btn.textContent = 'Sair do modo tela cheia';
          if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen().catch(()=>{});
          }
        } else {
          btn.textContent = 'Modo tela cheia';
          if (document.exitFullscreen) {
            document.exitFullscreen().catch(()=>{});
          }
        }
      });
    })();

    // ---------- FORECAST GLOBAL ----------
    let forecastChart = null;
    (function initForecast(){
      const ctx = document.getElementById('forecastChart');
      if (!ctx || !projecoes24h || projecoes24h.length === 0) return;

      const labels = projecoes24h.map(p => `${String(p.hora).padStart(2,'0')}h`);
      const data   = projecoes24h.map(p => parseFloat(p.valor_previsto));

      forecastChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Ocorrências estimadas',
            data,
            borderColor: '#2563eb',
            backgroundColor: 'rgba(96,165,250,0.25)',
            tension: 0.35,
            fill: true,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => `Estimado: ${ctx.parsed.y.toFixed(1)} ocorrências`
              }
            }
          },
          scales: {
            x: {
              ticks: { color: '#6b7280', font: { size: 10 } },
              grid: { display: false }
            },
            y: {
              ticks: { color: '#6b7280', font: { size: 10 } },
              grid: { color: '#e5e7eb' }
            }
          }
        }
      });
    })();

    // ---------- PREVISIBILIDADE DOS FATOS ----------
    (function buildPrevisibilidade(){
      const resumo = document.getElementById('previsibilidadeResumo');
      const lista  = document.getElementById('previsibilidadeLista');
      if (!resumo || !lista || !projecoes24h || projecoes24h.length === 0) return;

      const valores = projecoes24h.map(p => p.valor_previsto);
      const media = valores.reduce((a,b) => a+b, 0) / valores.length;
      const variacao = Math.sqrt(
        valores.reduce((acc,v) => acc + Math.pow(v-media,2), 0) / valores.length
      );

      // índice simples: quanto mais concentrados os picos, mais "previsível"
      const coefVar = variacao / (media || 1);
      let indice = 0;
      if (coefVar >= 1)       indice = 82;
      else if (coefVar >= .7) indice = 76;
      else if (coefVar >= .4) indice = 68;
      else                    indice = 60;

      resumo.innerHTML = `
        <div class="mb-1">
          <strong>Índice global de previsibilidade:</strong>
          <span class="badge-chip-primary ms-1">${indice}/100</span>
        </div>
        <div class="small-muted">
          Curva com média ${media.toFixed(1)} e desvio ${variacao.toFixed(1)} indica um cenário
          ${coefVar >= 0.7 ? 'altamente estruturado em poucas janelas críticas.' : 'mais distribuído, com risco pulverizado ao longo do dia.'}
        </div>
      `;

      lista.innerHTML = '';
      const li1 = document.createElement('li');
      li1.innerHTML = `Picos bem definidos permitem programar operações com antecedência de algumas horas.`;
      const li2 = document.createElement('li');
      li2.innerHTML = `Janelas em que o modelo mantém previsão alta de forma recorrente são candidatas a PB fixos.`;
      const li3 = document.createElement('li');
      li3.innerHTML = `Mudanças bruscas nesse índice podem indicar alteração de padrão criminógeno no bairro.`;
      [li1, li2, li3].forEach(li => lista.appendChild(li));
    })();

    // ---------- POR CRIME (seleção + gráficos + explicador) ----------
    let crimeHoraChart = null;
    let crimeBairroChart = null;

    function getCrimesList(){
      if (!crimesResumo || !Array.isArray(crimesResumo)) return [];
      return crimesResumo.map(c => c.crime);
    }

    function updateCrimeResumo(crime){
      const box = document.getElementById('crimeResumo');
      if (!box || !crimesResumo) return;
      const c = crimesResumo.find(x => x.crime === crime);
      if (!c) {
        box.textContent = 'Nenhuma informação disponível para este crime.';
        return;
      }
      box.innerHTML = `
        <div class="mb-1"><strong>${c.crime}</strong></div>
        <div class="small-muted mb-1">
          Total histórico em Jardim Camburi: <strong>${c.total}</strong> ocorrências.
        </div>
        <div>
          Nível de risco atual:
          <span class="pill-risk ${
            c.risco === 'alto' ? 'pill-risk-alto'
            : c.risco === 'médio' || c.risco === 'medio' ? 'pill-risk-medio'
            : 'pill-risk-baixo'
          }">
            ${c.risco || 'desconhecido'}
          </span>
        </div>
      `;
    }

    function buildCrimeHoraChart(crime){
      const ctx = document.getElementById('crimeHoraChart');
      if (!ctx || !crimeHora) return;

      const dados = crimeHora.filter(x => x.crime === crime);
      const labels = dados.map(d => `${String(d.hora).padStart(2,'0')}h`);
      const valores = dados.map(d => d.valor);

      if (crimeHoraChart) crimeHoraChart.destroy();
      crimeHoraChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Ocorrências estimadas',
            data: valores,
            backgroundColor: '#60a5fa',
            borderColor: '#2563eb',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => `Estimado: ${ctx.parsed.y.toFixed(1)} ocorrências`
              }
            }
          },
          scales: {
            x: { ticks: { color: '#6b7280', font: { size: 9 } }, grid: { display: false } },
            y: { ticks: { color: '#6b7280', font: { size: 9 } }, grid: { color: '#e5e7eb' } }
          }
        }
      });

      return {labels, valores};
    }

    function buildCrimeBairroChart(crime){
      const ctx = document.getElementById('crimeBairroChart');
      if (!ctx || !crimeHoraBairro) return;

      const dados = crimeHoraBairro.filter(x => x.crime === crime);
      const agreg = {};
      dados.forEach(d => {
        const b = d.bairro || 'S/I';
        agreg[b] = (agreg[b] || 0) + d.valor;
      });

      const entries = Object.entries(agreg).sort((a,b) => b[1] - a[1]).slice(0,7);
      const labels = entries.map(e => e[0]);
      const valores = entries.map(e => e[1]);

      if (crimeBairroChart) crimeBairroChart.destroy();
      crimeBairroChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Ocorrências estimadas',
            data: valores,
            backgroundColor: '#4ade80',
            borderColor: '#16a34a',
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => `Estimado: ${ctx.parsed.x.toFixed(1)} ocorrências`
              }
            }
          },
          scales: {
            x: { ticks: { color: '#6b7280', font: { size: 9 } }, grid: { color: '#e5e7eb' } },
            y: { ticks: { color: '#6b7280', font: { size: 9 } }, grid: { display: false } }
          }
        }
      });

      return {labels, valores};
    }

    function buildCrimeInsight(crime, horaInfo, bairroInfo){
      const box = document.getElementById('crimeInsight');
      if (!box) return;
      if (!horaInfo || !bairroInfo || !horaInfo.valores.length) {
        box.textContent = 'O modelo ainda não possui volume suficiente para gerar um padrão confiável para este crime.';
        return;
      }

      // pico horário
      let maxIdx = 0;
      for (let i=1;i<horaInfo.valores.length;i++){
        if (horaInfo.valores[i] > horaInfo.valores[maxIdx]) maxIdx = i;
      }
      const picoHora = horaInfo.labels[maxIdx];

      // pico bairro
      let maxBIdx = 0;
      for (let i=1;i<bairroInfo.valores.length;i++){
        if (bairroInfo.valores[i] > bairroInfo.valores[maxBIdx]) maxBIdx = i;
      }
      const picoBairro = bairroInfo.labels[maxBIdx];

      box.innerHTML = `
        Para <strong>${crime}</strong>, o motor identifica maior probabilidade em
        <strong>${picoHora}</strong>, com concentração relevante no bairro
        <strong>${picoBairro}</strong>. <br>
        Recomenda-se programar presença preventiva nessa combinação
        <strong>hora × bairro</strong>, especialmente em dias de maior fluxo.
      `;
    }

    (function initCrimeUI(){
      const select = document.getElementById('crimeSelect');
      if (!select) return;

      const crimes = getCrimesList();
      if (!crimes.length) {
        select.innerHTML = '<option>(sem dados por crime)</option>';
        return;
      }

      select.innerHTML = '';
      crimes.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
      });

      function refresh(){
        const crime = select.value;
        updateCrimeResumo(crime);
        const hInfo = buildCrimeHoraChart(crime);
        const bInfo = buildCrimeBairroChart(crime);
        buildCrimeInsight(crime, hInfo, bInfo);
      }

      select.addEventListener('change', refresh);
      refresh();
    })();

    // ---------- MATRIZ CRIME × HORA × BAIRRO ----------
    (function buildCrimeHoraBairroMatrix(){
      const table = document.getElementById('crimeHoraBairroHeatmap');
      if (!table || !crimeHoraBairro || !crimeHoraBairro.length) return;

      const sorted = [...crimeHoraBairro].sort((a,b) => b.valor - a.valor).slice(0, 50);
      const maxVal = sorted[0] ? sorted[0].valor : 1;

      table.innerHTML = '';
      const thead = document.createElement('thead');
      const trHead = document.createElement('tr');
      ['Crime','Bairro','Hora','Índice preditivo'].forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      sorted.forEach(item => {
        const tr = document.createElement('tr');

        const tdCrime = document.createElement('td');
        tdCrime.textContent = item.crime;
        tr.appendChild(tdCrime);

        const tdBairro = document.createElement('td');
        tdBairro.textContent = item.bairro || 'S/I';
        tr.appendChild(tdBairro);

        const tdHora = document.createElement('td');
        tdHora.textContent = `${String(item.hora).padStart(2,'0')}h`;
        tr.appendChild(tdHora);

        const tdIndice = document.createElement('td');
        const score = (item.valor / maxVal) * 100;
        const cellDiv = document.createElement('div');
        cellDiv.classList.add('heat-cell');
        if (score >= 70) cellDiv.classList.add('heat-high');
        else if (score >= 40) cellDiv.classList.add('heat-medium');
        else cellDiv.classList.add('heat-low');
        cellDiv.textContent = score.toFixed(0);
        tdIndice.appendChild(cellDiv);

        tr.appendChild(tdIndice);
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
    })();

    // ---------- MAPA LEAFLET ----------
    (function initMap() {
      const mapDiv = document.getElementById('map');
      if (!mapDiv) return;

      const center = [-20.2735, -40.2860]; // centro aproximado JC
      const map = L.map('map', {
        center: center,
        zoom: 14,
        zoomControl: false,
      });

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      const geoLookup = {
        "AV DANTE MICHELINI (TODAS AS VARIANTES)": [-20.2812, -40.2655],
        "RUA CARLOS MARTINS": [-20.2750, -40.2910],
        "S/I": center
      };

      const markersByLogradouro = {};
      if (topLogradouros && topLogradouros.length > 0) {
        const maxTotal = Math.max(...topLogradouros.map(l => l.total || 0));

        topLogradouros.forEach(l => {
          const nomeRaw = (l.logradouro || "");
          const nome = nomeRaw.toUpperCase();
          const val = l.total || 0;
          const base = geoLookup[nome] || center;

          const intensidade = maxTotal > 0 ? (0.4 + 0.6 * (val / maxTotal)) : 0.4;
          const radius = 80 + 220 * intensidade;

          const circle = L.circle(base, {
            radius: radius,
            color: '#2563eb',
            weight: 1,
            fillColor: '#60a5fa',
            fillOpacity: 0.25 + 0.35 * intensidade
          }).addTo(map)
            .bindPopup(`<strong>${nomeRaw}</strong><br>Total: ${val}`);

          markersByLogradouro[nome] = circle;
        });
      }

      document.querySelectorAll('[data-logradouro]').forEach(row => {
        row.addEventListener('click', () => {
          const nome = row.getAttribute('data-logradouro');
          const marker = markersByLogradouro[nome];
          if (marker) {
            map.flyTo(marker.getLatLng(), 16, { duration: 0.6 });
            marker.openPopup();
          }
        });
      });
    })();

    // ---------- ALERTAS COGNITIVOS ----------
    (function buildCognitiveAlerts() {
      const container = document.getElementById('alertasContainer');
      if (!container || !projecoes24h || projecoes24h.length === 0) return;

      const fallback = document.getElementById('alertasFallback');
      if (fallback) fallback.remove();

      const valores = projecoes24h.map(p => p.valor_previsto);
      const media = valores.reduce((a,b) => a + b, 0) / valores.length;
      const limAlto = media * 1.6;

      projecoes24h.forEach(p => {
        if (p.valor_previsto >= limAlto || p.risco === 'alto') {
          const div = document.createElement('div');
          div.classList.add('chip-critico');
          div.innerHTML = `
            <strong>Janela crítica ${String(p.hora).padStart(2,'0')}h</strong>
            <span class="small-muted ms-1">
              Projeção acima do padrão médio (${p.valor_previsto.toFixed(1)} vs média ${media.toFixed(1)}).
            </span>
          `;
          container.appendChild(div);
        }
      });

      if (!container.children.length) {
        const span = document.createElement('span');
        span.classList.add('small-muted');
        span.textContent = 'Nenhum alerta cognitivo relevante no padrão atual das projeções.';
        container.appendChild(span);
      }
    })();
  </script>
</body>
</html>
